<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>MoodRecipe Mobile</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Phone Device Container */
        .phone-container {
            width: 100%;
            max-width: 375px;
            margin: 20px auto;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1),
                0 0 60px rgba(0,0,0,0.5);
            border-radius: 40px;
            position: relative;
            overflow: hidden;
            background: #000;
            padding: 15px;
        }

        /* Phone Frame */
        .phone-frame {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 32px;
            overflow: hidden;
            background: #000;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        /* Phone Notch */
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 25px;
            background: #000;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding-top: 5px;
        }

        .phone-notch::before {
            content: '';
            width: 60px;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }

        .phone-notch::after {
            content: '';
            position: absolute;
            right: 30px;
            width: 8px;
            height: 8px;
            background: #222;
            border-radius: 50%;
        }

        /* Phone Screen (Actual App Content) */
        .phone-screen {
            position: relative;
            width: 100%;
            height: 720px;
            background: #f4f7f6;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            border-radius: 30px;
        }

        /* Phone Side Buttons */
        .phone-button {
            position: absolute;
            background: #333;
            border-radius: 2px;
        }

        .power-button {
            right: -4px;
            top: 80px;
            width: 4px;
            height: 40px;
        }

        .volume-up {
            right: -4px;
            top: 140px;
            width: 4px;
            height: 20px;
        }

        .volume-down {
            right: -4px;
            top: 170px;
            width: 4px;
            height: 20px;
        }

        /* Dark Mode Styles */
        .dark-mode {
            --bg: #121212;
            --card: #1f1f1f;
            --text: #eaeaea;
            --accent: #3aa88b;
            --button: #ffb703;
            --button-hover: #fb8500;
            --error: #ff6b6b;
            --success: #4caf50;
            --transition: all 0.3s ease;
        }

        .app-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            color: var(--text);
            transition: var(--transition);
        }

        /* Light Mode Default Variables */
        :root {
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #222;
            --accent: #6bc4a3;
            --button: #ffb703;
            --button-hover: #fb8500;
            --error: #ff6b6b;
            --success: #4caf50;
            --transition: all 0.3s ease;
        }

        /* App Header */
        .app-header {
            background: var(--accent);
            color: white;
            padding: 1.2rem 1rem 1rem;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding-top: 30px; /* For notch space */
        }

        .app-main {
            flex: 1;
            padding: 0.8rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        section {
            background: var(--card);
            margin: 0.8rem 0;
            padding: 1.2rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h1, h2, h3 {
            margin-bottom: 0.8rem;
            line-height: 1.3;
        }

        h1 {
            font-size: 1.5rem;
            text-align: center;
        }

        h2 {
            font-size: 1.2rem;
            color: var(--accent);
        }

        .mood-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin: 1rem 0;
        }

        button {
            padding: 1rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            background: var(--button);
            color: #222;
            font-weight: 600;
            transition: var(--transition);
            min-height: 55px;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        button span {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }

        button:hover, button:active {
            background: var(--button-hover);
            color: white;
            transform: translateY(-2px);
        }

        .card {
            background: var(--card);
            margin: 0.8rem 0;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .allergens {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .allergen-tag {
            background: rgba(255, 107, 107, 0.15);
            padding: 0.4rem 0.7rem;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .filter-section {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(107, 196, 163, 0.1);
            border-radius: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-top: 0.8rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            cursor: pointer;
        }

        .dark-mode .filter-item {
            background: rgba(255,255,255,0.1);
        }

        .toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            z-index: 10;
            transition: var(--transition);
        }

        .toggle:hover, .toggle:active {
            background: rgba(255,255,255,0.3);
        }

        .status-message {
            padding: 0.8rem;
            border-radius: 10px;
            margin: 0.8rem 0;
            text-align: center;
        }

        .success {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        .error {
            background: rgba(255, 107, 107, 0.15);
            color: var(--error);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--accent);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(107, 196, 163, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Screen Indicators */
        .phone-screen::-webkit-scrollbar {
            width: 4px;
        }

        .phone-screen::-webkit-scrollbar-track {
            background: transparent;
        }

        .phone-screen::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .dark-mode .phone-screen::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }

        /* App Footer */
        .app-footer {
            background: #222;
            color: white;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.8rem;
            margin-top: auto;
        }

        .dark-mode .app-footer {
            background: #111;
        }

        /* Responsive Adjustments */
        @media (max-width: 400px) {
            .phone-container {
                max-width: 320px;
                border-radius: 30px;
            }
            
            .phone-screen {
                height: 640px;
            }
            
            .mood-buttons {
                grid-template-columns: 1fr;
            }
            
            button {
                min-height: 50px;
                padding: 0.8rem;
            }
        }

        /* Focus styles for accessibility */
        button:focus-visible,
        .toggle:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Phone Device -->
    <div class="phone-container">
        <div class="phone-frame">
            <!-- Phone Buttons -->
            <div class="phone-button power-button"></div>
            <div class="phone-button volume-up"></div>
            <div class="phone-button volume-down"></div>
            
            <!-- Phone Notch -->
            <div class="phone-notch"></div>
            
            <!-- Phone Screen (App Content) -->
            <div class="phone-screen">
                <div class="app-content" id="appContent">
                    <header class="app-header">
                        <div class="toggle" onclick="toggleDarkMode()" role="button" aria-label="Toggle dark mode">
                            <span id="toggleIcon">üåô</span>
                            <span id="toggleText">Dark Mode</span>
                        </div>
                        <h1>üçΩÔ∏è MoodRecipe</h1>
                        <p>Find food based on your mood</p>
                    </header>

                    <main class="app-main">
                        <section class="location-section">
                            <h2>üìç Location</h2>
                            <button onclick="getLocation()">Detect My Location</button>
                            <div id="locationStatus" class="status-message">Location not detected yet.</div>
                        </section>

                        <section>
                            <h2>üòä How Are You Feeling?</h2>
                            
                            <div class="mood-buttons">
                                <button onclick="showOptions('happy')">
                                    <span>üòÑ</span> Happy
                                </button>
                                <button onclick="showOptions('sad')">
                                    <span>üò¢</span> Sad
                                </button>
                                <button onclick="showOptions('tired')">
                                    <span>üò¥</span> Tired
                                </button>
                                <button onclick="showOptions('stressed')">
                                    <span>üò´</span> Stressed
                                </button>
                                <button onclick="showOptions('bored')">
                                    <span>ü•±</span> Bored
                                </button>
                            </div>

                            <div class="filter-section">
                                <h3>üö´ Allergen Filters</h3>
                                <div class="filter-grid allergen-filters">
                                    <label class="filter-item">
                                        <input type="checkbox" value="nuts" onchange="applyAllergenFilter()">
                                        Nuts üå∞
                                    </label>
                                    <label class="filter-item">
                                        <input type="checkbox" value="milk" onchange="applyAllergenFilter()">
                                        Milk ü•õ
                                    </label>
                                    <label class="filter-item">
                                        <input type="checkbox" value="fish" onchange="applyAllergenFilter()">
                                        Fish üêü
                                    </label>
                                    <label class="filter-item">
                                        <input type="checkbox" value="eggs" onchange="applyAllergenFilter()">
                                        Eggs ü•ö
                                    </label>
                                    <label class="filter-item">
                                        <input type="checkbox" value="crustacean" onchange="applyAllergenFilter()">
                                        Crustacean ü¶ê
                                    </label>
                                    <label class="filter-item">
                                        <input type="checkbox" value="wheat" onchange="applyAllergenFilter()">
                                        Wheat üåæ
                                    </label>
                                </div>
                            </div>

                            <div id="loading" class="loading" style="display:none;">
                                <div class="spinner"></div>
                                <p>Finding perfect recipes...</p>
                            </div>

                            <div id="recipeResults"></div>
                            <button id="moreRecipesBtn" style="display:none; margin-top:1rem; width:100%;" 
                                    onclick="showMoreRecipes()">
                                ‚ûï Show More Recipes
                            </button>

                            <div id="restaurantResults" style="margin-top:1.5rem;"></div>
                        </section>
                    </main>

                    <footer class="app-footer">
                        <p>Powered by Geoapify & OpenStreetMap</p>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================
        // DARK MODE - FIXED
        // =======================
        function toggleDarkMode() {
            const appContent = document.getElementById('appContent');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');
            
            // Toggle dark mode class
            appContent.classList.toggle("dark-mode");
            
            // Check if dark mode is active
            const isDark = appContent.classList.contains("dark-mode");
            
            // Save preference to localStorage
            localStorage.setItem("darkMode", isDark);
            
            // Update toggle button
            if (isDark) {
                toggleIcon.textContent = '‚òÄÔ∏è';
                toggleText.textContent = 'Light Mode';
            } else {
                toggleIcon.textContent = 'üåô';
                toggleText.textContent = 'Dark Mode';
            }
        }

        // Initialize dark mode from localStorage
        function initializeDarkMode() {
            const appContent = document.getElementById('appContent');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');
            
            // Check localStorage for saved preference
            const savedDarkMode = localStorage.getItem("darkMode");
            
            if (savedDarkMode === "true") {
                appContent.classList.add("dark-mode");
                toggleIcon.textContent = '‚òÄÔ∏è';
                toggleText.textContent = 'Light Mode';
            } else {
                appContent.classList.remove("dark-mode");
                toggleIcon.textContent = 'üåô';
                toggleText.textContent = 'Dark Mode';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeDarkMode);

        // =======================
        // CONFIG & STATE
        // =======================
        const geoApiKey = "84f2d835ca2048dc86789c4475ede22b";
        let userLat = null, userLon = null;
        let currentMood = null, recipeIndex = 0;
        let shuffledRecipes = [], filteredRecipes = [];
        const RECIPES_PER_LOAD = 3;

        const allergenEmojis = {
            nuts: "üå∞", milk: "ü•õ", fish: "üêü", eggs: "ü•ö",
            crustacean: "ü¶ê", wheat: "üåæ", gluten: "üåæ"
        };
        
        let activeAllergens = [];

        // =======================
        // LOCATION HANDLING
        // =======================
        function getLocation() {
            const locationStatus = document.getElementById('locationStatus');
            const locationButton = document.querySelector('.location-section button');
            
            if (navigator.geolocation) {
                locationStatus.textContent = "Detecting location...";
                locationStatus.className = "status-message";
                locationButton.disabled = true;
                locationButton.textContent = "Detecting...";
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        
                        localStorage.setItem('userLocation', JSON.stringify({
                            lat: userLat,
                            lon: userLon
                        }));
                        
                        locationStatus.textContent = "Location detected! ‚úîÔ∏è";
                        locationStatus.className = "status-message success";
                        locationButton.disabled = false;
                        locationButton.textContent = "Update Location";
                        
                        // Add vibration feedback on success (mobile devices)
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    },
                    error => {
                        let message = "Location permission denied.";
                        if (error.code === error.TIMEOUT) {
                            message = "Location detection timed out.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            message = "Location information unavailable.";
                        }
                        
                        locationStatus.textContent = message;
                        locationStatus.className = "status-message error";
                        locationButton.disabled = false;
                        locationButton.textContent = "Try Again";
                    },
                    { 
                        timeout: 10000,
                        enableHighAccuracy: true 
                    }
                );
            } else {
                locationStatus.textContent = "Geolocation not supported.";
                locationStatus.className = "status-message error";
            }
        }

        // Load saved location
        function loadSavedLocation() {
            const savedLocation = localStorage.getItem('userLocation');
            if (savedLocation) {
                const location = JSON.parse(savedLocation);
                userLat = location.lat;
                userLon = location.lon;
                document.getElementById('locationStatus').textContent = "Using saved location ‚úîÔ∏è";
                document.getElementById('locationStatus').className = "status-message success";
            }
        }

        loadSavedLocation();

        // =======================
        // RECIPE GENERATOR
        // =======================
        function generateRecipes(mood) {
            const bases = {
                happy: ["Chicken", "Salmon", "Tofu", "Shrimp", "Veggie"],
                sad: ["Beef", "Chicken", "Cheese", "Pasta", "Potato"],
                tired: ["Egg", "Yogurt", "Oats", "Chicken", "Banana"],
                stressed: ["Rice", "Fish", "Tofu", "Lentils", "Veggies"],
                bored: ["Taco", "Pizza", "Wrap", "Burger", "Pasta"]
            };
            
            const styles = ["Bowl", "Bake", "Grill", "Stir-Fry", "Wrap", "Skillet", "Salad"];
            const flavors = ["Garlic", "Creamy", "Spicy", "Herb", "Lemon", "Classic", "Sweet"];
            
            const allergenMap = {
                Cheese: ["milk"], Yogurt: ["milk"], Egg: ["eggs"],
                Shrimp: ["crustacean", "fish"], Salmon: ["fish"],
                Pasta: ["gluten", "wheat"], Pizza: ["gluten", "milk", "wheat"],
                Wrap: ["gluten", "wheat"], Burger: ["gluten", "wheat"],
                Taco: ["gluten", "wheat"], Oats: ["gluten", "wheat"]
            };

            const recipeSet = new Set();
            const recipes = [];
            
            while (recipes.length < 50) {
                const base = bases[mood][Math.floor(Math.random() * bases[mood].length)];
                const style = styles[Math.floor(Math.random() * styles.length)];
                const flavor = flavors[Math.floor(Math.random() * flavors.length)];
                
                const recipeName = `${flavor} ${base} ${style}`;
                
                if (!recipeSet.has(recipeName)) {
                    recipeSet.add(recipeName);
                    recipes.push({
                        name: recipeName,
                        allergens: allergenMap[base] || []
                    });
                }
            }
            
            return recipes;
        }

        // =======================
        // UTILITIES
        // =======================
        function recipeLink(name) {
            return `https://www.google.com/search?q=${encodeURIComponent(name + " recipe")}`;
        }

        function addCard(container, html) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = html;
            container.appendChild(card);
        }

        // =======================
        // FILTERING SYSTEM
        // =======================
        function applyAllergenFilter() {
            activeAllergens = [...document.querySelectorAll('.allergen-filters input:checked')]
                .map(input => input.value);
                
            recipeIndex = 0;
            filteredRecipes = shuffledRecipes.filter(recipe => 
                !recipe.allergens.some(allergen => activeAllergens.includes(allergen))
            );
            
            document.getElementById('recipeResults').innerHTML = "";
            showRecipes();
        }

        // =======================
        // RECIPE DISPLAY
        // =======================
        function showRecipes() {
            const recipeResults = document.getElementById('recipeResults');
            const moreRecipesBtn = document.getElementById('moreRecipesBtn');
            const list = activeAllergens.length ? filteredRecipes : shuffledRecipes;
            
            if (recipeIndex === 0) {
                const header = document.createElement('h3');
                header.textContent = 'üçΩÔ∏è Recipe Options';
                recipeResults.appendChild(header);
            }
            
            const endIndex = Math.min(recipeIndex + RECIPES_PER_LOAD, list.length);
            const currentRecipes = list.slice(recipeIndex, endIndex);
            
            currentRecipes.forEach(recipe => {
                let allergensHTML = "";
                if (recipe.allergens.length > 0) {
                    allergensHTML = `<div class="allergens">${recipe.allergens.map(allergen => 
                        `<span class="allergen-tag">${allergenEmojis[allergen]} ${allergen}</span>`
                    ).join('')}</div>`;
                }
                
                addCard(recipeResults, `
                    <a href="${recipeLink(recipe.name)}" target="_blank">${recipe.name}</a>
                    ${allergensHTML}
                `);
            });
            
            recipeIndex = endIndex;
            moreRecipesBtn.style.display = recipeIndex < list.length ? "block" : "none";
        }

        function showMoreRecipes() {
            showRecipes();
        }

        // =======================
        // RESTAURANT FINDER
        // =======================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * 
                Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
                
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(2);
        }

        async function showRestaurants() {
            const restaurantResults = document.getElementById('restaurantResults');
            restaurantResults.innerHTML = "";
            
            const header = document.createElement('h3');
            header.textContent = 'üè™ Nearby Restaurants';
            restaurantResults.appendChild(header);
            
            if (!userLat || !userLon) {
                addCard(restaurantResults, "üìç Enable location services to find restaurants.");
                return;
            }
            
            try {
                const response = await fetch(
                    `https://api.geoapify.com/v2/places?categories=catering.restaurant&filter=circle:${userLon},${userLat},1500&limit=6&apiKey=${geoApiKey}`
                );
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    addCard(restaurantResults, "No restaurants found within 1.5km.");
                    return;
                }
                
                data.features.forEach(place => {
                    if (!place.properties.name) return;
                    
                    const [lon, lat] = place.geometry.coordinates;
                    const distance = calculateDistance(userLat, userLon, lat, lon);
                    
                    addCard(restaurantResults, `
                        <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}">
                            üó∫Ô∏è ${place.properties.name}
                        </a>
                        <div class="allergens">
                            <span class="allergen-tag">üìè ${distance} km away</span>
                        </div>
                    `);
                });
                
            } catch (error) {
                addCard(restaurantResults, `
                    ‚ùå Error loading restaurants.
                    <div class="error">Please try again later.</div>
                `);
            }
        }

        // =======================
        // MAIN FUNCTIONALITY
        // =======================
        function showOptions(mood) {
            const buttons = document.querySelectorAll('.mood-buttons button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = "0.7";
            });
            
            currentMood = mood;
            recipeIndex = 0;
            shuffledRecipes = generateRecipes(mood);
            filteredRecipes = [];
            
            const recipeResults = document.getElementById('recipeResults');
            const restaurantResults = document.getElementById('restaurantResults');
            const loading = document.getElementById('loading');
            const moreRecipesBtn = document.getElementById('moreRecipesBtn');
            
            recipeResults.innerHTML = "";
            restaurantResults.innerHTML = "";
            loading.style.display = "flex";
            moreRecipesBtn.style.display = "none";
            
            setTimeout(() => {
                loading.style.display = "none";
                applyAllergenFilter();
                showRestaurants();
                
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                });
                
                // Highlight selected mood
                buttons.forEach(btn => {
                    if (btn.textContent.includes(mood.charAt(0).toUpperCase() + mood.slice(1))) {
                        btn.style.background = "var(--button-hover)";
                        btn.style.color = "white";
                    } else {
                        btn.style.background = "";
                        btn.style.color = "";
                    }
                });
            }, 800);
        }

        // Mobile-specific touch improvements
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Add screen wake lock for better mobile experience
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(() => {});
        }
    </script>
</body>
</html>