<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MoodRecipe</title>

<style>
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f7f6;
    text-align: center;
}

header {
    background: #6bc4a3;
    color: white;
    padding: 25px;
}

section {
    background: white;
    margin: 25px auto;
    padding: 20px;
    border-radius: 15px;
    max-width: 600px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

button {
    padding: 12px 20px;
    margin: 6px;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    background: #ffb703;
}

button:hover {
    background: #fb8500;
    color: white;
}

.card {
    background: #f9f9f9;
    margin: 10px auto;
    padding: 12px 18px;
    border-radius: 12px;
    max-width: 420px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    text-align: left;
}

.card a {
    text-decoration: none;
    color: #333;
    font-weight: bold;
}

.allergens {
    display: block;
    font-size: 14px;
    color: #d9534f;
    margin-top: 4px;
}

#loading {
    display: none;
    font-size: 18px;
    color: #6bc4a3;
}

.allergen-filters {
    margin: 10px 0;
    text-align: left;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

footer {
    background: #333;
    color: white;
    padding: 12px;
    margin-top: 30px;
}
</style>
</head>

<body>

<header>
    <h1>ğŸ½ï¸ MoodRecipe</h1>
    <p>Find food and restaurants based on your mood</p>
</header>

<section>
    <h2>ğŸ“ Location</h2>
    <button onclick="getLocation()">Detect My Location</button>
    <p id="locationText">Location not detected yet.</p>
</section>

<section>
    <h2>ğŸ˜Š How Are You Feeling?</h2>

    <button onclick="showOptions('happy')">Happy</button>
    <button onclick="showOptions('sad')">Sad</button>
    <button onclick="showOptions('tired')">Tired</button>
    <button onclick="showOptions('stressed')">Stressed</button>
    <button onclick="showOptions('bored')">Bored</button>

    <div class="allergen-filters">
        <label><input type="checkbox" value="nuts" onchange="applyAllergenFilter()"> Nuts ğŸŒ°</label>
        <label><input type="checkbox" value="milk" onchange="applyAllergenFilter()"> Milk ğŸ¥›</label>
        <label><input type="checkbox" value="fish" onchange="applyAllergenFilter()"> Fish ğŸŸ</label>
        <label><input type="checkbox" value="eggs" onchange="applyAllergenFilter()"> Eggs ğŸ¥š</label>
        <label><input type="checkbox" value="crustacean" onchange="applyAllergenFilter()"> Crustacean ğŸ¦</label>
        <label><input type="checkbox" value="wheat" onchange="applyAllergenFilter()"> Wheat ğŸŒ¾</label>
        <label><input type="checkbox" value="gluten" onchange="applyAllergenFilter()"> Gluten ğŸŒ¾</label>
    </div>

    <div id="loading">ğŸ” Searching...</div>

    <div id="recipeResults"></div>
    <button id="moreRecipesBtn" style="display:none;" onclick="showMoreRecipes()">â• Show More Recipes</button>

    <div id="restaurantResults"></div>
</section>

<footer>
    Powered by Geoapify / OpenStreetMap
</footer>

<script>
// =======================
// CONFIG & STATE
// =======================
const geoApiKey = "84f2d835ca2048dc86789c4475ede22b";
let userLat = null;
let userLon = null;

let currentMood = null;
let recipeIndex = 0;
let shuffledRecipes = [];
let filteredRecipes = [];
const RECIPES_PER_LOAD = 3;

// Allergens emojis
const allergenEmojis = {
    nuts: "ğŸŒ°",
    milk: "ğŸ¥›",
    fish: "ğŸŸ",
    eggs: "ğŸ¥š",
    crustacean: "ğŸ¦",
    wheat: "ğŸŒ¾",
    gluten: "ğŸŒ¾"
};

let activeAllergens = []; // selected filters

// =======================
// LOCATION
// =======================
function getLocation() {
    const text = document.getElementById("locationText");

    navigator.geolocation.getCurrentPosition(
        pos => {
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;
            text.innerText = "Location detected âœ”";
        },
        () => {
            text.innerText = "Location denied.";
        }
    );
}

// =======================
// DATA (recipes with allergens)
// =======================
const moods = {
    happy: [
        {name:"Rainbow tacos ğŸŒ®", allergens: []},
        {name:"Fruit smoothie ğŸ“", allergens:["milk"]},
        {name:"Grilled chicken wrap ğŸ¥™", allergens: ["gluten","wheat"]},
        {name:"Fresh salad ğŸ¥—", allergens: []},
        {name:"Yogurt parfait ğŸ¨", allergens: ["milk","nuts"]},
        {name:"Mango salsa bowl ğŸ¥­", allergens: []},
        {name:"Chicken Caesar wrap ğŸ”", allergens: ["gluten","milk","wheat"]},
        {name:"Veggie burrito ğŸŒ¯", allergens: ["gluten","wheat"]},
        {name:"Pasta primavera ğŸ", allergens: ["gluten","wheat"]},
        {name:"Berry pancakes ğŸ«", allergens: ["gluten","milk","eggs","wheat"]},
        {name:"Falafel pita ğŸ§†", allergens: ["gluten","nuts","wheat"]},
        {name:"Caprese sandwich ğŸ§€", allergens: ["milk","gluten","wheat"]},
        {name:"Shrimp tacos ğŸ¤", allergens: ["fish","gluten","crustacean","wheat"]},
        {name:"Lemon rice ğŸ‹", allergens: []},
        {name:"Smoothie bowl ğŸŒ", allergens:["milk","nuts"]}
    ],
    // Repeat for sad, tired, stressed, bored (same structure as before)...
    sad: [
        {name:"Chocolate pancakes ğŸ¥", allergens:["gluten","milk","eggs","wheat"]},
        {name:"Warm soup ğŸ²", allergens:[]},
        {name:"Mac & cheese ğŸ§€", allergens:["gluten","milk","wheat"]},
        {name:"Toast with jam ğŸ", allergens:["gluten","wheat"]},
        {name:"Hot cocoa â˜•", allergens:["milk"]},
        {name:"Mashed potatoes ğŸ¥”", allergens:["milk"]},
        {name:"Grilled cheese ğŸ§ˆ", allergens:["gluten","milk","wheat"]},
        {name:"Ramen noodles ğŸœ", allergens:["gluten","fish","wheat"]},
        {name:"Chicken pot pie ğŸ¥§", allergens:["gluten","milk","eggs","wheat"]},
        {name:"Baked ziti ğŸ", allergens:["gluten","milk","wheat"]},
        {name:"Brownies ğŸ«", allergens:["gluten","milk","nuts","eggs","wheat"]},
        {name:"Creamy risotto ğŸš", allergens:["milk"]},
        {name:"French toast ğŸ", allergens:["gluten","milk","eggs","wheat"]},
        {name:"Chili stew ğŸŒ¶ï¸", allergens:[]},
        {name:"Rice pudding ğŸ®", allergens:["milk","eggs"]}
    ],
    tired: [
        {name:"Avocado toast ğŸ¥‘", allergens:["gluten","nuts","wheat"]},
        {name:"Scrambled eggs ğŸ³", allergens:["eggs","milk"]},
        {name:"Protein smoothie ğŸ¥¤", allergens:["milk","nuts"]},
        {name:"Energy bowl ğŸ¥£", allergens:["nuts"]},
        {name:"Banana oatmeal ğŸŒ", allergens:["gluten","nuts","wheat"]},
        {name:"Greek yogurt ğŸ¶", allergens:["milk"]},
        {name:"Peanut butter toast ğŸ¥œ", allergens:["gluten","nuts","wheat"]},
        {name:"Egg sandwich ğŸ¥ª", allergens:["gluten","eggs","milk","wheat"]},
        {name:"Breakfast burrito ğŸŒ¯", allergens:["gluten","eggs","wheat"]},
        {name:"Overnight oats ğŸŒ¾", allergens:["gluten","milk","nuts","wheat"]},
        {name:"Trail mix ğŸ¥œ", allergens:["nuts"]},
        {name:"Cottage cheese ğŸ¶", allergens:["milk"]},
        {name:"Hard-boiled eggs ğŸ¥š", allergens:["eggs"]},
        {name:"Granola bar ğŸ¯", allergens:["gluten","nuts","wheat"]},
        {name:"Green smoothie ğŸ¥¬", allergens:[]}
    ],
    stressed: [
        {name:"Vegetable soup ğŸµ", allergens:[]},
        {name:"Spinach pasta ğŸ", allergens:["gluten","wheat"]},
        {name:"Green salad ğŸ¥—", allergens:[]},
        {name:"Herbal tea â˜•", allergens:[]},
        {name:"Rice bowl ğŸš", allergens:[]},
        {name:"Miso soup ğŸ²", allergens:["fish"]},
        {name:"Steamed veggies ğŸ¥¦", allergens:[]},
        {name:"Quinoa bowl ğŸŒ¾", allergens:[]},
        {name:"Baked salmon ğŸŸ", allergens:["fish"]},
        {name:"Tofu stir-fry ğŸœ", allergens:[]},
        {name:"Chamomile tea ğŸŒ¼", allergens:[]},
        {name:"Roasted sweet potato ğŸ ", allergens:[]},
        {name:"Lentil soup ğŸ«˜", allergens:[]},
        {name:"Brown rice & veggies ğŸ›", allergens:[]},
        {name:"Cucumber salad ğŸ¥’", allergens:[]}
    ],
    bored: [
        {name:"DIY sushi ğŸ£", allergens:["fish"]},
        {name:"Mini pizza ğŸ•", allergens:["gluten","milk","wheat"]},
        {name:"Loaded sandwiches ğŸ¥ª", allergens:["gluten","milk","wheat"]},
        {name:"Build-your-own tacos ğŸŒ®", allergens:["gluten","wheat"]},
        {name:"Popcorn snacks ğŸ¿", allergens:[]},
        {name:"Nachos ğŸ§€", allergens:["milk"]},
        {name:"Quesadillas ğŸŒ¯", allergens:["gluten","milk","wheat"]},
        {name:"Sliders ğŸ”", allergens:["gluten","wheat"]},
        {name:"Flatbread pizza ğŸ•", allergens:["gluten","milk","wheat"]},
        {name:"Stuffed peppers ğŸŒ¶ï¸", allergens:[]},
        {name:"Spring rolls ğŸ¥¬", allergens:["gluten","wheat"]},
        {name:"Fried rice ğŸš", allergens:[]},
        {name:"Pasta bake ğŸ", allergens:["gluten","milk","wheat"]},
        {name:"Chicken wraps ğŸ”", allergens:["gluten","wheat"]},
        {name:"Snack platter ğŸ§€", allergens:["milk"]}
    ]
};

// =======================
// UTIL & FILTER
// =======================
function shuffleArray(array){return [...array].sort(()=>0.5-Math.random());}
function recipeLink(recipe){return `https://www.google.com/search?q=${encodeURIComponent(recipe.replace(/[^\w\s]/gi,""))} recipe`;}
function addCard(container, html){container.innerHTML+=`<div class="card">${html}</div>`;}

function applyAllergenFilter(){
    activeAllergens = Array.from(document.querySelectorAll('.allergen-filters input:checked')).map(i=>i.value);
    if(!currentMood) return;
    recipeIndex=0;
    filteredRecipes = shuffledRecipes.filter(r=>!r.allergens.some(a=>activeAllergens.includes(a)));
    document.getElementById("recipeResults").innerHTML="";
    showRecipesFiltered();
}

function showRecipesFiltered(){
    const container = document.getElementById("recipeResults");
    const moreBtn = document.getElementById("moreRecipesBtn");
    const next = filteredRecipes.slice(recipeIndex, recipeIndex+RECIPES_PER_LOAD);

    if(recipeIndex===0) container.innerHTML="<h3>ğŸ½ï¸ Recipe Options</h3>";

    next.forEach(r=>{
        const allergenDisplay = r.allergens.map(a=>allergenEmojis[a]).join(" ");
        addCard(container,
            `<a href="${recipeLink(r.name)}" target="_blank">${r.name}</a>`+
            (allergenDisplay?`<span class="allergens">${allergenDisplay}</span>`:"")
        );
    });

    recipeIndex += RECIPES_PER_LOAD;
    moreBtn.style.display = recipeIndex<filteredRecipes.length?"inline-block":"none";
}

function showMoreRecipes(){ activeAllergens.length?showRecipesFiltered():showRecipes(); }

function showRecipes(){
    const container=document.getElementById("recipeResults");
    const moreBtn=document.getElementById("moreRecipesBtn");
    if(recipeIndex===0) container.innerHTML="<h3>ğŸ½ï¸ Recipe Options</h3>";
    const next=shuffledRecipes.slice(recipeIndex,recipeIndex+RECIPES_PER_LOAD);
    next.forEach(r=>{
        const allergenDisplay=r.allergens.map(a=>allergenEmojis[a]).join(" ");
        addCard(container,
            `<a href="${recipeLink(r.name)}" target="_blank">${r.name}</a>`+
            (allergenDisplay?`<span class="allergens">${allergenDisplay}</span>`:"")
        );
    });
    recipeIndex+=RECIPES_PER_LOAD;
    moreBtn.style.display=recipeIndex<shuffledRecipes.length?"inline-block":"none";
}

// =======================
// RESTAURANTS
// =======================
function calculateDistance(lat1,lon1,lat2,lon2){
    const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function showRestaurants(container){
    container.innerHTML="<h3>ğŸª Nearby Restaurants</h3>";
    if(!userLat||!userLon){addCard(container,"ğŸ“ Please enable location to see nearby restaurants."); return;}
    try{
        const res=await fetch(`https://api.geoapify.com/v2/places?categories=catering.restaurant&filter=circle:${userLon},${userLat},1500&limit=8&apiKey=${geoApiKey}`);
        const data=await res.json();
        if(!data.features.length) addCard(container,"No nearby restaurants found.");
        data.features.forEach(place=>{
            if(!place.properties.name) return;
            const [lon,lat]=place.geometry.coordinates;
            const mapsUrl=`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
            const distance=calculateDistance(userLat,userLon,lat,lon).toFixed(2);
            addCard(container,`<a href="${mapsUrl}" target="_blank">${place.properties.name}</a><br><small>ğŸ“ ${distance} km away</small>`);
        });
    }catch{addCard(container,"Unable to load restaurants.");}
}

// =======================
// MAIN
// =======================
function showOptions(mood){
    const loading=document.getElementById("loading");
    const restaurantDiv=document.getElementById("restaurantResults");

    currentMood=mood;
    recipeIndex=0;
    shuffledRecipes=shuffleArray(moods[mood]);
    filteredRecipes=[];

    document.getElementById("recipeResults").innerHTML="";
    restaurantDiv.innerHTML="";
    loading.style.display="block";

    setTimeout(async()=>{
        loading.style.display="none";
        applyAllergenFilter(); // applies filter if any selected
        await showRestaurants(restaurantDiv);
    },800);
}
</script>

</body>
</html>
