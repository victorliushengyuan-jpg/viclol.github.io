<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MoodRecipe</title>

<style>
:root {
    --bg:#f4f7f6;
    --card:#ffffff;
    --text:#222;
    --accent:#6bc4a3;
    --button:#ffb703;
    --button-hover:#fb8500;
}
body.dark {
    --bg:#121212;
    --card:#1f1f1f;
    --text:#eaeaea;
    --accent:#3aa88b;
}

body {
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:var(--bg);
    color:var(--text);
    text-align:center;
    transition:.3s;
}
header {
    background:var(--accent);
    color:white;
    padding:25px;
    position:relative;
}
.toggle {
    position:absolute;
    top:15px;
    right:15px;
    background:rgba(255,255,255,.25);
    padding:8px 14px;
    border-radius:20px;
    cursor:pointer;
}
section {
    background:var(--card);
    margin:25px auto;
    padding:20px;
    border-radius:15px;
    max-width:600px;
    box-shadow:0 4px 10px rgba(0,0,0,.15);
}
button {
    padding:12px 20px;
    margin:6px;
    border:none;
    border-radius:25px;
    font-size:16px;
    cursor:pointer;
    background:var(--button);
}
button:hover {
    background:var(--button-hover);
    color:white;
}
.card {
    background:var(--card);
    margin:15px auto;
    padding:12px;
    border-radius:12px;
    max-width:420px;
    box-shadow:0 3px 6px rgba(0,0,0,.2);
    text-align:left;
    overflow:hidden;
}
.card img {
    width:100%;
    height:160px;
    object-fit:cover;
    border-radius:10px;
    margin-bottom:8px;
}
.card a {
    text-decoration:none;
    color:var(--text);
    font-weight:bold;
    display:block;
}
.allergens {
    font-size:14px;
    color:#ff6b6b;
    margin-top:4px;
    display:block;
}
#loading {
    display:none;
    color:var(--accent);
}
.allergen-filters {
    text-align:left;
    max-width:600px;
    margin:10px auto;
}
footer {
    background:#222;
    color:white;
    padding:12px;
    margin-top:30px;
}
</style>
</head>

<body>

<header>
    <div class="toggle" onclick="toggleDarkMode()">ğŸŒ™ Dark</div>
    <h1>ğŸ½ï¸ MoodRecipe</h1>
    <p>Find food and restaurants based on your mood</p>
</header>

<section>
    <h2>ğŸ“ Location</h2>
    <button onclick="getLocation()">Detect My Location</button>
    <p id="locationText">Location not detected yet.</p>
</section>

<section>
    <h2>ğŸ˜Š How Are You Feeling?</h2>

    <button onclick="showOptions('happy')">Happy</button>
    <button onclick="showOptions('sad')">Sad</button>
    <button onclick="showOptions('tired')">Tired</button>
    <button onclick="showOptions('stressed')">Stressed</button>
    <button onclick="showOptions('bored')">Bored</button>

    <div class="allergen-filters">
        <label><input type="checkbox" value="nuts" onchange="applyAllergenFilter()"> Nuts ğŸŒ°</label><br>
        <label><input type="checkbox" value="milk" onchange="applyAllergenFilter()"> Milk ğŸ¥›</label><br>
        <label><input type="checkbox" value="fish" onchange="applyAllergenFilter()"> Fish ğŸŸ</label><br>
        <label><input type="checkbox" value="eggs" onchange="applyAllergenFilter()"> Eggs ğŸ¥š</label><br>
        <label><input type="checkbox" value="crustacean" onchange="applyAllergenFilter()"> Crustacean ğŸ¦</label><br>
        <label><input type="checkbox" value="wheat" onchange="applyAllergenFilter()"> Wheat ğŸŒ¾</label><br>
        <label><input type="checkbox" value="gluten" onchange="applyAllergenFilter()"> Gluten ğŸŒ¾</label>
    </div>

    <div id="loading">ğŸ” Searching...</div>

    <div id="recipeResults"></div>
    <button id="moreRecipesBtn" style="display:none;" onclick="showMoreRecipes()">â• Show More Recipes</button>

    <div id="restaurantResults"></div>
</section>

<footer>
    Powered by Geoapify / OpenStreetMap
</footer>

<script>
// =======================
// DARK MODE
// =======================
function toggleDarkMode(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}
if(localStorage.getItem("darkMode")==="true"){document.body.classList.add("dark");}

// =======================
// CONFIG
// =======================
const geoApiKey="84f2d835ca2048dc86789c4475ede22b";
let userLat=null,userLon=null;
let recipeIndex=0;
let shuffledRecipes=[],filteredRecipes=[];
let activeAllergens=[];
const RECIPES_PER_LOAD=3;

const allergenEmojis={nuts:"ğŸŒ°",milk:"ğŸ¥›",fish:"ğŸŸ",eggs:"ğŸ¥š",crustacean:"ğŸ¦",wheat:"ğŸŒ¾",gluten:"ğŸŒ¾"};

// =======================
// LOCATION
// =======================
function getLocation(){
    navigator.geolocation.getCurrentPosition(
        p=>{userLat=p.coords.latitude;userLon=p.coords.longitude;locationText.innerText="Location detected âœ”";},
        ()=>locationText.innerText="Location denied."
    );
}

// =======================
// RECIPES (70) with images
// =======================
function generateRecipes(mood){
    const bases={
        happy:["Chicken","Salmon","Tofu","Shrimp","Veggie"],
        sad:["Beef","Cheese","Pasta","Potato","Chicken"],
        tired:["Egg","Yogurt","Oats","Banana","Chicken"],
        stressed:["Rice","Fish","Tofu","Lentils","Veggies"],
        bored:["Pizza","Burger","Wrap","Taco","Pasta"]
    };
    const styles=["Bowl","Bake","Grill","Stir-Fry","Wrap","Skillet","Salad"];
    const flavors=["Garlic","Creamy","Spicy","Herb","Lemon","Classic","Sweet"];
    const allergenMap={
        Cheese:["milk"],Yogurt:["milk"],Egg:["eggs"],
        Shrimp:["crustacean","fish"],Salmon:["fish"],
        Pasta:["gluten","wheat"],Pizza:["gluten","milk","wheat"],
        Wrap:["gluten","wheat"],Burger:["gluten","wheat"],
        Taco:["gluten","wheat"],Oats:["gluten","wheat"]
    };
    const list=[];
    for(let b of bases[mood]){
        for(let s of styles){
            for(let f of flavors){
                if(list.length>=70) return shuffle(list);
                list.push({name:`${f} ${b} ${s}`,allergens:allergenMap[b]||[]});
            }
        }
    }
    return shuffle(list);
}

// =======================
// UTIL
// =======================
function shuffle(a){return [...a].sort(()=>0.5-Math.random());}
function recipeLink(n){return `https://www.google.com/search?q=${encodeURIComponent(n+" recipe")}`;}
// âœ… IMAGE FIXED: add &sig to prevent caching
function recipeImage(n){return `https://source.unsplash.com/400x300/?food,${encodeURIComponent(n)}&sig=${Math.random()}`;}
function addCard(el,r){
    const allergens=r.allergens.map(a=>allergenEmojis[a]).join(" ");
    el.innerHTML+=`
    <div class="card">
        <img src="${recipeImage(r.name)}" alt="${r.name}" onerror="this.src='https://via.placeholder.com/400x300?text=Recipe+Image'">
        <a href="${recipeLink(r.name)}" target="_blank">${r.name}</a>
        ${allergens?`<span class="allergens">${allergens}</span>`:""}
    </div>`;
}

// =======================
// FILTER
// =======================
function applyAllergenFilter(){
    activeAllergens=[...document.querySelectorAll('.allergen-filters input:checked')].map(i=>i.value);
    recipeIndex=0;
    filteredRecipes=shuffledRecipes.filter(r=>!r.allergens.some(a=>activeAllergens.includes(a)));
    recipeResults.innerHTML="";
    showRecipes();
}

// =======================
// DISPLAY
// =======================
function showRecipes(){
    const list=activeAllergens.length?filteredRecipes:shuffledRecipes;
    if(recipeIndex===0) recipeResults.innerHTML="<h3>ğŸ½ï¸ Recipe Options</h3>";
    list.slice(recipeIndex,recipeIndex+RECIPES_PER_LOAD).forEach(r=>addCard(recipeResults,r));
    recipeIndex+=RECIPES_PER_LOAD;
    moreRecipesBtn.style.display=recipeIndex<list.length?"inline-block":"none";
}
function showMoreRecipes(){showRecipes();}

// =======================
// RESTAURANTS
// =======================
function distance(lat1,lon1,lat2,lon2){
    const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2);
}

async function showRestaurants(){
    restaurantResults.innerHTML="<h3>ğŸª Nearby Restaurants</h3>";
    if(!userLat||!userLon){restaurantResults.innerHTML+="<p>Enable location</p>";return;}
    const r=await fetch(`https://api.geoapify.com/v2/places?categories=catering.restaurant&filter=circle:${userLon},${userLat},1500&limit=6&apiKey=${geoApiKey}`);
    const d=await r.json();
    d.features.forEach(p=>{
        if(!p.properties.name) return;
        const [lon,lat]=p.geometry.coordinates;
        restaurantResults.innerHTML+=`
        <div class="card">
            <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}">ğŸ—ºï¸ ${p.properties.name}</a>
            <small>${distance(userLat,userLon,lat,lon)} km away</small>
        </div>`;
    });
}

// =======================
// MAIN
// =======================
function showOptions(mood){
    recipeIndex=0;
    shuffledRecipes=generateRecipes(mood);
    filteredRecipes=[];
    recipeResults.innerHTML="";
    restaurantResults.innerHTML="";
    loading.style.display="block";
    setTimeout(()=>{
        loading.style.display="none";
        applyAllergenFilter();
        showRestaurants();
    },600);
}
</script>

</body>
</html>
